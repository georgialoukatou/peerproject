---
title             : "Peer speech project"
---

```{r setup,  include = FALSE, echo=TRUE, message=FALSE}
library(childesr)
library(dplyr)


transcripts_ <-get_participants()
exclude<-c("Biling", "Clinical", "Clinical-MOR")
d=subset(transcripts_, !(transcripts_$collection_name %in% exclude)) #exclude bilingual and clinical studies

#1 CHECK 1st selection : corpora out of lab, > than 2 speakers
#2 CHECK names not found: BolKuiken, Chroma, Jamaican, Berman, CCLAS, Yamaguchi, Paris, Goadrose, Tsay, Zhou3


outofLab<-c("LeeWongLeung","Beijing","TCCM","Zhou3","ZhouDinner","Tsay", "Jakarta", "Jiwon", "Ryu", "Bloom70", "Braunwald", "Brown", "Clark", "Gleason",  "Hall", "Kuczaj", "Post", "Sachs", "Snow", "Suppes", "Valian","Providence", "Champaud", "Geneva","Goadrose", "Leveille", "Paris", "Pauline", "Yamaguchi", "York", "Caroline", "Leo", "Miller", "Rigol","Wagner", "Plunkett", "Kari", "Ringstad", "Aguirre", "Linaza", "LlinasOjea", "Marrero", "Nieva", "OreaPine", "Ornat", "Romero", "Vila","Soto", "CCLAS", "Argus", "Kohler", "Korgesaar", "Vija", "Zupping", "Family", "Samadi", "Doukas", "BatEl", "Berman", "Levy", "Ravid", "Bodor", "Reger", "Jamaican", "Demuth", "Narasimhan", "Gaeltacht", "Wijnen", "Utrecht", "Stellenbosch", "Belfast", "Forrester", "Lara", "Wells", "Hamasaki", "Ishii", "MiiPro", "Miyata", "Jordina", "Julia", "MireiaEvaPascual", "SerraSole", "Antelmi", "Calambrone", "Klammler", "Roma", "Florianopolis", "Santos", "Avram", "Kovacevic", "Chroma", "Protassova", "Tanja", "SCECL", "BSF", "BolKuiken", "Thomas", "MPI-EVA-Manchester", "Beek") 


cSelect=subset(d, (d$corpus_name %in% outofLab))


i<-1

#verifies if all corpora have at least 3 speakers
for (corpus in unique(cSelect$corpus_name)){
  eachdb=cSelect[cSelect$corpus_name==corpus,]
  if (length(unique(eachdb$role)) < 3) {unique(eachdb$corpus_name) }
}

unique(cSelect$role)
```
Out of the  lab corpora: 
 `r unique(cSelect$corpus_name)` 
 
Number of out of  the lab corpora:  `r length(unique(cSelect$corpus_name))` 

Role tags in all CHILDES : `r unique(cSelect$role) `

```{r child speech corpus, echo=TRUE, message=FALSE}
#finds corpora with peer speech
namePeerSpeech=list()
dataPeer=list()

#3 CHECK: all cousins, boys etc Nnot adults?
childSpeakers=c("Sister", "Brother", "Playmate", "Teenager", "Cousin", "Child", "Girl", "Sibling", "Boy")

cSelectPeer=subset(cSelect, (cSelect$role %in% childSpeakers))
peerCorpusName=unique(cSelectPeer$corpus_name)



```
Out of lab CHILDES corpora with child speech (tags= `r head(childSpeakers)`):  `r peerCorpusName` 

Number of CHILDES corpora with peer speech: `r length(peerCorpusName)`

```{r read_csv, eval=FALSE, echo = TRUE, message=FALSE} 
# counts number of utterances per speaker for the selected out-of-lab corpora
#This chunk takes time to compute!
tablep=data.frame()

i=1
for (name in peerCorpusName[1:2]) {   #choosing only first 2 corpora to have it compile faster! 
  cp<-get_utterances(corpus=name)
  tabletmp_<-cp %>% group_by(speaker_role) %>% summarise(no_rows = length(speaker_role))
  tablep<-rbind(tablep, tabletmp_)
  i=i+1}
tablep

nuttsSummary<-tablep %>% group_by(speaker_role) %>% summarise(no_rows = sum(no_rows))
nuttsSummary


```

Per corpus Number of utterances per speaker for CHILDES corpora with peer speech: (see table)
Total Number of utterances per speaker for CHILDES corpora with peer speech: (see nuttsSummary)

```{r wireless, eval=FALSE, include=TRUE, message=FALSE, echo=TRUE}
# counts number of utterances per speaker for the selected out-of-lab corpora with wireless recordings

tablew=data.frame()

#4 CHECK if only these
wirelessCorpusName<-c("Wells", "Demuth", "Hall")

i=1
for (name in wirelessCorpusName) {
  cw<-get_utterances(corpus=name)
  tabletmp<-cw %>% group_by(speaker_role) %>% summarise(no_rows = length(speaker_role))
  tablew<-rbind(tablew, tabletmp)
  i=i+1}
tablew

nuttsWirelessSummary<-tablew %>% group_by(speaker_role) %>% summarise(no_rows = sum(no_rows))
nuttsWirelessSummary
```

Per corpus Number of utterances per speaker for CHILDES corpora with peer speech AND wireless recordings: (see tablew)
Total Number of utterances per speaker for CHILDES corpora with peer speech AND wireless recordings: (see nuttsWirelessSummary)



```{r demuth preparation, eval=TRUE, include=TRUE, message=FALSE}

lang<-"Sesotho"

#reads demuth corpus and counts utterances per speaker
demuth<-read.csv(file="sesotho_emilie_CDI.csv", header=TRUE) # memory processing problems, can't load googlesheets library
#number of utterances per speaker
sesotho_speakers<- demuth %>% group_by(role_raw) %>% summarise(no_rows = length(role_raw))
#order by number of utt
sesotho_speakers<- sesotho_speakers %>%   arrange(desc(no_rows))
#create data.frame
sesotho_speakers<-as.data.frame(sesotho_speakers)
#remove target child utts  
sesotho_speakers_input<-subset(sesotho_speakers, !(sesotho_speakers$role_raw=="Target_Child"))
sesotho_speakers_input

## NUMBER OF UTTERANCW BY SPEAKER


#number  of total input utterances
total_demuth_input<-sum(sesotho_speakers_input$no_rows)

#mother input:
sesotho_mother<-subset(sesotho_speakers_input, (sesotho_speakers_input$role_raw=="Mother"))
# percentage of utterances by mother in total input
sesotho_mother$no_rows/total_demuth_input *100 #25.25171

#siblings input:
sesotho_siblings<-subset(sesotho_speakers_input, (sesotho_speakers_input$role_raw=="Sister" |sesotho_speakers_input$role_raw=="Brother" ))
# percentage of utterances by siblings in total input
sum(sesotho_siblings$no_rows/total_demuth_input) *100 #15.22764

#other children input:
sesotho_peers<-subset(sesotho_speakers_input, (sesotho_speakers_input$role_raw=="Cousin" |sesotho_speakers_input$role_raw=="Playmate" | sesotho_speakers_input$role_raw=="Teenager"))
# percentage of utterances by peers in total input
sum(sesotho_peers$no_rows/total_demuth_input) *100 #29.58352

#other adult input:
sesotho_adults<-subset(sesotho_speakers_input, ( sesotho_speakers_input$role_raw=="Grandmother" | sesotho_speakers_input$role_raw=="Uncle" | sesotho_speakers_input$role_raw=="Adult" |  sesotho_speakers_input$role_raw=="Father"    ))
# percentage of utterances by other adultsin total input
sum(sesotho_adults$no_rows/total_demuth_input)* 100 #16.4653

```

```{r demuth directedness, eval=TRUE, include=TRUE, message=FALSE}

#ADRESSEE ANNOTATIONS PART

#annotated utterances by Emilie

demuth_annotated<-demuth[1:36782,]   #this is 53% annotated is this correct ???
#Remove all target child aka the one recorded utterances
demuth_annotated_input<-subset(demuth_annotated, !(demuth_annotated$role_raw=="Target_Child"))

#classify into categories the different speakers 
demuth_annotated_input$childdirected<-as.factor(demuth_annotated_input$childdirected)
#total utterances 
total_demuth_annotated_input<-length(demuth_annotated_input$utterance_id) # 21042

##CREATE TABLE of different speakers in the corpus
demuth_annotated_table<- demuth_annotated_input %>% group_by(childdirected) %>% summarise(no_rows = length(childdirected))#there is a warning message about:  Factor `childdirected` contains implicit NA, consider using `forcats::fct_explicit_na`

#treat the table as a data.frame
demuth_annotated_table<-as.data.frame(demuth_annotated_table)
# re order by descending number
demuth_annotated_table<- demuth_annotated_table %>%   arrange(desc(no_rows))
demuth_annotated_table


# Utterances addressed to the target child  aka CDS
demuth_child_directed<-subset(demuth_annotated_input, (demuth_annotated_input$childdirected=="1"))
demuth_cd_directed_utts<- as.data.frame(demuth_child_directed %>%select(utterance))
#write.table(demuth_cd_directed_utts, file=paste0(lang, "Demuthchilddirected.txt"), row.names=F, col.names=T,  quote=F)  !!!  i slighlty change this so be careful if you use it in CLAN or elsewhere from childdirected.txt to Demuthchilddirected.txt

#percentage of child directed speech vs total annotated
length(demuth_child_directed$utterance)/total_demuth_annotated_input *100 #85.60498


#matches addressee with speaker roles (especially for non-child directed)
speaker_info_demuth<- as.data.frame(unique(demuth %>%select(speaker_id, role_raw)))
colnames(speaker_info_demuth)[colnames(speaker_info_demuth)=="role_raw"] <- "role_adressee"
annotated_speaker_info_demuth<-merge(x=demuth_annotated_input, y=speaker_info_demuth, by.x="childdirected", by.y="speaker_id", all.x=TRUE, sort=TRUE)

# Utterances addressed to adults aka ADS
demuth_adult_directed<-subset(annotated_speaker_info_demuth, !(annotated_speaker_info_demuth$role_adressee=="Playmate"| annotated_speaker_info_demuth$role_adressee=="Cousin"|annotated_speaker_info_demuth$role_adressee=="?"| annotated_speaker_info_demuth$childdirected=="SELF"| annotated_speaker_info_demuth$role_adressee=="SELF"| annotated_speaker_info_demuth$role_adressee=="Brother"| annotated_speaker_info_demuth$childdirected=="NA"| annotated_speaker_info_demuth$role_adressee=="Teenager"|annotated_speaker_info_demuth$role_adressee=="Sister"|annotated_speaker_info_demuth$childdirected=="1"|annotated_speaker_info_demuth$childdirected=="0"|annotated_speaker_info_demuth$childdirected=="O"))

#subset all utterances marked as ADS
demuth_ad_directed_utts<- as.data.frame(demuth_adult_directed %>%select(utterance))
#export all ADS utterance into a text file
write.table(demuth_ad_directed_utts, file=paste0("Sesothoadultdirected"), row.names=F, col.names=T,  quote=F) 

#percentage of adult directed speech vs total annotated
length(demuth_adult_directed$utterance)/total_demuth_annotated_input *100 #4.148845

#Utterances marked as NO directed speech 
demuth_na_directed<-subset(demuth_annotated_input, (demuth_annotated_input$childdirected=="NA" |demuth_annotated_input$childdirected=="?"  ))
demuth_nodirected_utts<- as.data.frame(demuth_na_directed %>%select(utterance))
#write.table(demuth_nodirected_utts, file=paste0( lang, "Demuth_nodirected"), row.names=F, col.names=T,  quote=F) !!! ALSO NAME CHANGED !!!

#percentage of child directed speech vs total annotated
length(demuth_na_directed$utterance)/total_demuth_annotated_input *100 #2.917974

``` 

```{r demuth sentence type, eval=TRUE, include=TRUE, message=FALSE}

#Utterances type analysis

#Utterances marked as CDS
demuth_sentence_type_child_annotated<- demuth_child_directed %>% group_by(sentence_type) %>% summarise(no_rows = length(sentence_type))
#Utterances marked as questions
directed_questions<-subset(demuth_sentence_type_child_annotated, (demuth_sentence_type_child_annotated$sentence_type=="question"))
#percentage marked as questions in CDS annotated corpus 
directed_questions$no_rows/sum(demuth_sentence_type_child_annotated$no_rows) *100 #40.12102

#Sentences marked as ADS
demuth_sentence_type_adult_annotated<- demuth_adult_directed %>% group_by(sentence_type) %>% summarise(no_rows = length(sentence_type))
#Utterances marked as questions
adultdirected_questions<-subset(demuth_sentence_type_adult_annotated, (demuth_sentence_type_adult_annotated$sentence_type=="question"))
#percentage marked as questions in ADS annotated corpus 
adultdirected_questions$no_rows/sum(demuth_sentence_type_adult_annotated$no_rows)*100 #20.38946


```


```{r wells preparation, eval=TRUE, include=TRUE, message=FALSE}

#load Wells data

lang<-"English"
wells<-read.csv(file="wells.csv", header=TRUE) #11,866

#mark corpus by keychild cs: I checked twice i someone wants to double check awesome
wells$keychild <- NA
wells$keychild [1:2278] <- "benjamin"
wells$keychild [2279:3400] <- "samantha"
wells$keychild [3401:3962] <- "debbie"
wells$keychild [3963:4776] <- "sheila"
wells$keychild [4777:5601] <- "stella"
wells$keychild [5602:7224] <- "abigail"
wells$keychild [7225:9038] <- "geoffrey"
wells$keychild [9039:10909] <- "harriet"
wells$keychild [10910:11866] <- "laura"

#add gender
wells$gender [wells$keychild == "benjamin"] <- "M"
wells$gender [wells$keychild == "samantha"] <- "F"
wells$gender [wells$keychild == "debbie"] <- "F"
wells$gender [wells$keychild == "samantha"] <- "F"
wells$gender [wells$keychild == "sheila"] <- "F"
wells$gender [wells$keychild == "stella"] <- "F"
wells$gender [wells$keychild == "abigail"] <- "F"
wells$gender [wells$keychild == "geoffrey"] <- "M"
wells$gender [wells$keychild == "harriet"] <- "F" #assuming girl
wells$gender [wells$keychild == "laura"] <- "F"


#remove target child utts  aka 4,830 entries
#wells_input<- wells[!grepl("Target", wells$ROLE),] 
wells$speaker[wells$ROLE == "Mother"] <- "mother"
wells$speaker[grep("Sister|Brother|Sibling", wells$ROLE)]  <- "sibling"
wells$speaker[grep("Child|Playmate|child", wells$ROLE)]  <- "peer"
wells$speaker[grep("Adult|Uncle|Grandmother|Family_Friend|Visitor|Aunt|Father", wells$ROLE)]  <- "adult"
wells$speaker[grep("Target", wells$ROLE)] <- "Target_Child"



colnames(wells)<-c("NAME"   ,   "ROLE"   ,   "UTTERANCE", "COMMENT"  , "DIRECTED" , "empty"     ,    "empty2"     ,  "keychild" , "gender"   , "speaker")
write.table(wells, file=paste0("wells_input.txt"), row.names=F, col.names=T,  quote=F) 


aggregate(wells$UTTERANCE,by=list( wells$speaker, wells$keychild),length )->sum_wells

try<- wells %>% group_by(keychild) %>% summarise(no_rows = length(keychild)) # 21042


colnames(sum_wells) <- c("speaker", "keychild", "nb_utt")

ggplot(sum_wells, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="dodge")
``` 

```{r wells directedness, eval=TRUE, include=TRUE, message=FALSE}


#NOT WORKING FOR SOME REASON:
#read.table("wells_input.txt",header=F)->wells_input

#ADRESSEE ANNOTATIONS PART
wells_annotated_input<-subset(wells, !(wells$DIRECTED=="")) #select utterances annotated by Naomi Alex up to now , for now 2059 rows PLEASE UPDATE as we go !!

# count different types of addressees 
wells_annotated_value<- wells_annotated_input %>% group_by(DIRECTED) %>% summarise(no_rows = length(DIRECTED))
#create a data.frame
wells_annotated_value<-as.data.frame(wells_annotated_value)
#Number of number  of utts that have annotated adressees
wells_total_annotated_input<-sum(wells_annotated_value$no_rows)  #2059
wells_annotated_value

# Utterances addressed to the target child  aka CDS
wells_child_directed<-subset(wells_annotated_input, (wells_annotated_input$DIRECTED=="CHI")) #wells annotated child-directed corpus
# n of child-directed utterances
length(wells_child_directed$UTTERANCE)/ length(wells_annotated_input$UTTERANCE)  * 100 #45.07042
#subset all utterances marked as CDS
wells_cd_directed_utts<- as.data.frame(wells_child_directed %>%select(UTTERANCE))
#export all CDS utterance into a text file
write.table(wells_cd_directed_utts, file=paste0( lang,"Wellschilddirected.txt"), row.names=F, col.names=T,  quote=F) 

# Utterances addressed to adults aka ADS

#for this it needed to know the corpus quite well... So I'm assuming that LOU - REB - RAC - CHR - 0 - NIC ARE NOT ADULTS right???
well_adult_directed<-subset(wells_annotated_input, !(wells_annotated_input$DIRECTED=="CHI" |wells_annotated_input$DIRECTED=="0" |wells_annotated_input$DIRECTED=="O" | wells_annotated_input$DIRECTED=="?" | wells_annotated_input$DIRECTED=="SELF"| wells_annotated_input$DIRECTED=="NIC"  | wells_annotated_input$DIRECTED=="TELEPHONE" | wells_annotated_input$DIRECTED=="MIX" | wells_annotated_input$DIRECTED=="LOU" | wells_annotated_input$DIRECTED=="REB" | wells_annotated_input$DIRECTED=="PET"| wells_annotated_input$DIRECTED=="RAC" | wells_annotated_input$DIRECTED=="CHR" | wells_annotated_input$DIRECTED=="NA"))
#subset all utterances marked as ADS
wells_ad_directed_utts<- as.data.frame(well_adult_directed %>%select(UTTERANCE))
#export all ADS utterance into a text file
write.table(wells_ad_directed_utts, file=paste0(lang, "Wellsadultdirected.txt"), row.names=F, col.names=T,  quote=F) 

 # n of adult directed utterances
length(wells_ad_directed_utts$UTTERANCE)/ length(wells_annotated_input$UTTERANCE) * 100 #22.38951 %

#NA annotations
#cs: whart about 0 ???
wells_annotated_na <- subset(wells_annotated_input,(wells_annotated_input$DIRECTED=="?"|wells_annotated_input$DIRECTED=="NA"|wells_annotated_input$DIRECTED==""|wells_annotated_input$DIRECTED==" "))
length(wells_annotated_na$UTTERANCE)/ length(wells_annotated_input$UTTERANCE) *100 # 5.68237 % 


```

```{r figure making, eval=TRUE, include=TRUE, message=FALSE}

read.table("wells_input_speakers.txt",header=T)->wells_input_speakers


#install libraries
library(ggplot2)
library(scales)
library(gridExtra)



#bar plot of CDS vs ADS per corpus
ggplot(overlap_incdata, aes( fill=source, y=tot, x=agecat)) +
  geom_bar(stat="identity", position="fill") + guides(fill=guide_legend(title=NULL))  +  scale_x_discrete(limits=c("<1", "1", "2" , "3", ">4" )) + labs(
    x="Age in years", y="Proportion of Linguistic Input") + scale_fill_discrete(labels= c("Adults",  "Children", "Main Female Caregiver")) +
  guides(fill=FALSE) + theme(axis.text.x = element_text(size = 10),  axis.text.y = element_text(size = 10), axis.title.y=element_text(size=15))


MFV <- ggplot(subset(forsourcegraphs,source %in% c("MFV")), aes(
   x=age_mo, y= tot, color=cds, size=min_coded )) +  geom_jitter(
     aes(x=age_mo))   + labs(x="Age in Months", y="Total input speech vocalizations (mins/h)")  +  guides(size=FALSE, color=F)

children <- ggplot(subset(forsourcegraphs,source %in% c("children")), aes(
   x=age_mo, y= tot, color=cds, size=min_coded )) +  geom_jitter(
     aes(x=age_mo))    +  guides(size=FALSE, color=F) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

adults <- ggplot(subset(forsourcegraphs,source %in% c("adult")), aes(
   x=age_mo, y= tot, color=cds, size=min_coded )) +  geom_jitter(
     aes(x=age_mo))   +  guides(size=FALSE, color=F) + theme(axis.title.x=element_blank(), axis.title.y=element_blank())

grid.arrange(MFV, children, adults, nrow = 1)


overlap_stackplot_OVERALL <- ggplot(overlap_incdata, aes( fill=source, y=tot, x=agecat)) +
  geom_bar(stat="identity", position="fill") + guides(fill=guide_legend(title=NULL))  +  scale_x_discrete(limits=c("<1", "1", "2" , "3", ">4" )) + labs(
    x="Age in years", y="Proportion of Linguistic Input") + scale_fill_discrete(labels= c("Adults",  "Children", "Main Female Caregiver")) +
  guides(fill=FALSE) + theme(axis.text.x = element_text(size = 10),  axis.text.y = element_text(size = 10), axis.title.y=element_text(size=15))


overlap_stackplot_CDS <- ggplot(subset(overall_forsourcegraphs, cds %in% T ), aes(fill=source, y=tot, x=agecat)) +
  geom_bar(stat="identity", position="fill") + guides(fill=guide_legend(title=NULL))  +  scale_x_discrete(limits=c("<1", "1", "2" , "3", ">4" )) + labs(
    x="Age in years", y="Proportion of Linguistic Input") + scale_fill_discrete(labels= c("Adults",  "Children", "Main Female Caregiver")) +
    guides(fill=FALSE) + theme( axis.title.y=element_blank(), axis.text.x = element_text(size = 10),  axis.text.y = element_text(size = 10))


grid.arrange(overlap_stackplot_OVERALL, overlap_stackplot_CDS, nrow = 1)







```
