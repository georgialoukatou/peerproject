---
title             : "Peer speech project"
---

```{r setup,  include = FALSE, echo=TRUE, message=FALSE}
library(childesr)
library(dplyr)


transcripts_ <-get_participants()
exclude<-c("Biling", "Clinical", "Clinical-MOR")
d=subset(transcripts_, !(transcripts_$collection_name %in% exclude)) #exclude bilingual and clinical studies

#1 CHECK 1st selection : corpora out of lab, > than 2 speakers
#2 CHECK names not found: BolKuiken, Chroma, Jamaican, Berman, CCLAS, Yamaguchi, Paris, Goadrose, Tsay, Zhou3


outofLab<-c("LeeWongLeung","Beijing","TCCM","Zhou3","ZhouDinner","Tsay", "Jakarta", "Jiwon", "Ryu", "Bloom70", "Braunwald", "Brown", "Clark", "Gleason",  "Hall", "Kuczaj", "Post", "Sachs", "Snow", "Suppes", "Valian","Providence", "Champaud", "Geneva","Goadrose", "Leveille", "Paris", "Pauline", "Yamaguchi", "York", "Caroline", "Leo", "Miller", "Rigol","Wagner", "Plunkett", "Kari", "Ringstad", "Aguirre", "Linaza", "LlinasOjea", "Marrero", "Nieva", "OreaPine", "Ornat", "Romero", "Vila","Soto", "CCLAS", "Argus", "Kohler", "Korgesaar", "Vija", "Zupping", "Family", "Samadi", "Doukas", "BatEl", "Berman", "Levy", "Ravid", "Bodor", "Reger", "Jamaican", "Demuth", "Narasimhan", "Gaeltacht", "Wijnen", "Utrecht", "Stellenbosch", "Belfast", "Forrester", "Lara", "Wells", "Hamasaki", "Ishii", "MiiPro", "Miyata", "Jordina", "Julia", "MireiaEvaPascual", "SerraSole", "Antelmi", "Calambrone", "Klammler", "Roma", "Florianopolis", "Santos", "Avram", "Kovacevic", "Chroma", "Protassova", "Tanja", "SCECL", "BSF", "BolKuiken", "Thomas", "MPI-EVA-Manchester", "Beek") 


cSelect=subset(d, (d$corpus_name %in% outofLab))


i<-1

#verifies if all corpora have at least 3 speakers
for (corpus in unique(cSelect$corpus_name)){
  eachdb=cSelect[cSelect$corpus_name==corpus,]
  if (length(unique(eachdb$role)) < 3) {unique(eachdb$corpus_name) }
}

unique(cSelect$role)
```
Out of the  lab corpora: 
 `r unique(cSelect$corpus_name)` 
 
Number of out of  the lab corpora:  `r length(unique(cSelect$corpus_name))` 

Role tags in all CHILDES : `r unique(cSelect$role) `

```{r child speech corpus, echo=TRUE, message=FALSE}
#finds corpora with peer speech
namePeerSpeech=list()
dataPeer=list()

#3 CHECK: all cousins, boys etc Nnot adults?
childSpeakers=c("Sister", "Brother", "Playmate", "Teenager", "Cousin", "Child", "Girl", "Sibling", "Boy")

cSelectPeer=subset(cSelect, (cSelect$role %in% childSpeakers))
peerCorpusName=unique(cSelectPeer$corpus_name)



```
Out of lab CHILDES corpora with child speech (tags= `r head(childSpeakers)`):  `r peerCorpusName` 

Number of CHILDES corpora with peer speech: `r length(peerCorpusName)`

```{r read_csv, eval=FALSE, echo = TRUE, message=FALSE} 
# counts number of utterances per speaker for the selected out-of-lab corpora
#This chunk takes time to compute!
tablep=data.frame()

i=1
for (name in peerCorpusName[1:2]) {   #choosing only first 2 corpora to have it compile faster! 
  cp<-get_utterances(corpus=name)
  tabletmp_<-cp %>% group_by(speaker_role) %>% summarise(no_rows = length(speaker_role))
  tablep<-rbind(tablep, tabletmp_)
  i=i+1}
tablep

nuttsSummary<-tablep %>% group_by(speaker_role) %>% summarise(no_rows = sum(no_rows))
nuttsSummary


```

Per corpus Number of utterances per speaker for CHILDES corpora with peer speech: (see table)
Total Number of utterances per speaker for CHILDES corpora with peer speech: (see nuttsSummary)

```{r wireless, eval=FALSE, include=TRUE, message=FALSE, echo=TRUE}
# counts number of utterances per speaker for the selected out-of-lab corpora with wireless recordings

tablew=data.frame()

#4 CHECK if only these
wirelessCorpusName<-c("Wells", "Demuth", "Hall")

i=1
for (name in wirelessCorpusName) {
  cw<-get_utterances(corpus=name)
  tabletmp<-cw %>% group_by(speaker_role) %>% summarise(no_rows = length(speaker_role))
  tablew<-rbind(tablew, tabletmp)
  i=i+1}
tablew

nuttsWirelessSummary<-tablew %>% group_by(speaker_role) %>% summarise(no_rows = sum(no_rows))
nuttsWirelessSummary
```

Per corpus Number of utterances per speaker for CHILDES corpora with peer speech AND wireless recordings: (see tablew)
Total Number of utterances per speaker for CHILDES corpora with peer speech AND wireless recordings: (see nuttsWirelessSummary)



```{r demuth preparation, eval=TRUE, include=TRUE, message=FALSE}

lang<-"Sesotho"

#reads demuth corpus and counts utterances per speaker
demuth<-read.csv(file="sesotho_emilie_CDI.csv", header=TRUE) # memory processing problems, can't load googlesheets 

#mark corpus by keychild cs: I checked twice i someone wants to double check awesome
demuth$keychild <- NA
demuth$keychild[demuth$session_id_fk.x %in% c(2414:2458)] <- "Hlobohang"
demuth$keychild[demuth$session_id_fk.x %in% c(2459:2503)] <- "Litlhare"
demuth$keychild[demuth$session_id_fk.x %in% c(2504:2542)] <- "Tsebo"


#number of utterances per speaker

demuth$speaker[demuth$role_raw == "Mother"] <- "mother"
demuth$speaker[demuth$role_raw == "Investigator"] <- "investigator"
demuth$speaker[grep("Sister|Brother|Sibling", demuth$role_raw)]  <- "sibling"
demuth$speaker[grep("Child|Playmate|child|Teenager|Cousin", demuth$role_raw)]  <- "peer"
demuth$speaker[grep("Adult|Uncle|Grandmother|Family_Friend|Visitor|Aunt|Father", demuth$role_raw)]  <- "adult"
demuth$speaker[grep("Target", demuth$role_raw)] <- "Target_Child"


#save changes
write.table(demuth, file=paste0("demuth_input.txt"), row.names=F, col.names=T,  quote=F) 

#Sum the number of utterances per speaker category and keychild
aggregate(demuth$utterance_id,by=list( demuth$speaker, demuth$keychild),length )->sum_demuth
colnames(sum_demuth) <- c("speaker", "keychild", "nb_utt")

#lenght demuth by child
trybis<- demuth %>% group_by(keychild) %>% summarise(no_rows = length(keychild)) # 11866

#sesotho_speakers<- demuth %>% group_by(role_raw) %>% summarise(no_rows = length(role_raw))
#number  of total input utterances
#total_demuth_input<-sum(sesotho_speakers_input$no_rows)
```

```{r demuth directedness, eval=TRUE, include=TRUE, message=FALSE}

#ADRESSEE ANNOTATIONS PART

#annotated utterances by Emilie

demuth_annotated<-demuth[1:36782,]   #this is 53% annotated is this correct ???

#Sum the number of utterances per speaker category and keychild
aggregate(demuth_annotated$utterance_id,by=list( demuth_annotated$speaker, demuth_annotated$keychild),length )->sum_demuth_annotated
colnames(sum_demuth_annotated) <- c("speaker", "keychild", "nb_utt")


#Sum the number of utterances per speaker category and keychild and ADDRESSEE
aggregate(demuth_annotated$utterance_id,by=list(demuth_annotated$childdirected,  demuth_annotated$speaker, demuth_annotated$keychild),length )->sum_demuth_addressee
colnames(sum_demuth_addressee) <- c("addresse", "speaker", "keychild", "nb_utt")

# Utterances addressed to the target child  aka CDS
demuth_child_directed<-subset(demuth_annotated, (demuth_annotated$childdirected==1))

aggregate(demuth_child_directed$utterance_id,by=list(demuth_child_directed$speaker, demuth_child_directed$keychild),length )->sum_demuth_CDS
colnames(sum_demuth_CDS) <- c( "speaker", "keychild", "nb_utt")

#Remove all target child aka the one recorded utterances
demuth_annotated_input<-subset(demuth_annotated, !(demuth_annotated$role_raw=="Target_Child"))

#classify into categories the different speakers 
demuth_annotated_input$childdirected<-as.factor(demuth_annotated_input$childdirected)
#total utterances 
total_demuth_annotated_input<-length(demuth_annotated_input$utterance_id) # 21042

##CREATE TABLE of different speakers in the corpus
demuth_annotated_table<- demuth_annotated_input %>% group_by(childdirected) %>% summarise(no_rows = length(childdirected))#there is a warning message about:  Factor `childdirected` contains implicit NA, consider using `forcats::fct_explicit_na`

#treat the table as a data.frame
demuth_annotated_table<-as.data.frame(demuth_annotated_table)
# re order by descending number
demuth_annotated_table<- demuth_annotated_table %>%   arrange(desc(no_rows))
demuth_annotated_table


# Utterances addressed to the target child  aka CDS
demuth_child_directed<-subset(demuth_annotated_input, (demuth_annotated_input$childdirected=="1"))
demuth_cd_directed_utts<- as.data.frame(demuth_child_directed %>%select(utterance))
#write.table(demuth_cd_directed_utts, file=paste0(lang, "Demuthchilddirected.txt"), row.names=F, col.names=T,  quote=F)  !!!  i slighlty change this so be careful if you use it in CLAN or elsewhere from childdirected.txt to Demuthchilddirected.txt

#percentage of child directed speech vs total annotated
length(demuth_child_directed$utterance)/total_demuth_annotated_input *100 #85.60498


#matches addressee with speaker roles (especially for non-child directed)
speaker_info_demuth<- as.data.frame(unique(demuth %>%select(speaker_id, role_raw)))
colnames(speaker_info_demuth)[colnames(speaker_info_demuth)=="role_raw"] <- "role_adressee"
annotated_speaker_info_demuth<-merge(x=demuth_annotated_input, y=speaker_info_demuth, by.x="childdirected", by.y="speaker_id", all.x=TRUE, sort=TRUE)

# Utterances addressed to adults aka ADS (basically anything that is not a known child right?)
demuth_adult_directed<-subset(annotated_speaker_info_demuth, !(annotated_speaker_info_demuth$role_adressee=="Playmate"| annotated_speaker_info_demuth$role_adressee=="Cousin"|annotated_speaker_info_demuth$role_adressee=="?"| annotated_speaker_info_demuth$childdirected=="SELF"| annotated_speaker_info_demuth$role_adressee=="SELF"| annotated_speaker_info_demuth$role_adressee=="Brother"| annotated_speaker_info_demuth$childdirected=="NA"| annotated_speaker_info_demuth$role_adressee=="Teenager"|annotated_speaker_info_demuth$role_adressee=="Sister"|annotated_speaker_info_demuth$childdirected=="1"|annotated_speaker_info_demuth$childdirected=="0"|annotated_speaker_info_demuth$childdirected=="O"))

#subset all utterances marked as ADS
demuth_ad_directed_utts<- as.data.frame(demuth_adult_directed %>%select(utterance))
#export all ADS utterance into a text file
write.table(demuth_ad_directed_utts, file=paste0("Sesothoadultdirected"), row.names=F, col.names=T,  quote=F) 

#percentage of adult directed speech vs total annotated
length(demuth_adult_directed$utterance)/total_demuth_annotated_input *100 #4.148845

#Utterances marked as NO directed speech 
demuth_na_directed<-subset(demuth_annotated_input, (demuth_annotated_input$childdirected=="NA" |demuth_annotated_input$childdirected=="?"  ))
demuth_nodirected_utts<- as.data.frame(demuth_na_directed %>%select(utterance))
#write.table(demuth_nodirected_utts, file=paste0( lang, "Demuth_nodirected"), row.names=F, col.names=T,  quote=F) !!! ALSO NAME CHANGED !!!

#percentage of child directed speech vs total annotated
length(demuth_na_directed$utterance)/total_demuth_annotated_input *100 #2.917974

``` 

```{r demuth sentence type, eval=TRUE, include=TRUE, message=FALSE}

#Utterances type analysis

#Utterances marked as CDS
demuth_sentence_type_child_annotated<- demuth_child_directed %>% group_by(sentence_type) %>% summarise(no_rows = length(sentence_type))
#Utterances marked as questions
directed_questions<-subset(demuth_sentence_type_child_annotated, (demuth_sentence_type_child_annotated$sentence_type=="question"))
#percentage marked as questions in CDS annotated corpus 
directed_questions$no_rows/sum(demuth_sentence_type_child_annotated$no_rows) *100 #40.12102

#Sentences marked as ADS
demuth_sentence_type_adult_annotated<- demuth_adult_directed %>% group_by(sentence_type) %>% summarise(no_rows = length(sentence_type))
#Utterances marked as questions
adultdirected_questions<-subset(demuth_sentence_type_adult_annotated, (demuth_sentence_type_adult_annotated$sentence_type=="question"))
#percentage marked as questions in ADS annotated corpus 
adultdirected_questions$no_rows/sum(demuth_sentence_type_adult_annotated$no_rows)*100 #20.38946


```


```{r wells preparation, eval=TRUE, include=TRUE, message=FALSE}

#load Wells data

lang<-"English"
wells<-read.table(file="wells.csv", header=TRUE, sep="\t") #11,866

#mark corpus by keychild cs: I checked twice i someone wants to double check awesome
wells$keychild <- NA
wells$keychild [1:2278] <- "benjamin"
wells$keychild [2279:3400] <- "samantha"
wells$keychild [3401:3962] <- "debbie"
wells$keychild [3963:4776] <- "sheila"
wells$keychild [4777:5601] <- "stella"
wells$keychild [5602:7224] <- "abigail"
wells$keychild [7225:9038] <- "geoffrey"
wells$keychild [9039:10909] <- "harriet"
wells$keychild [10910:11866] <- "laura"

#add gender
wells$gender [wells$keychild == "benjamin"] <- "M"
wells$gender [wells$keychild == "samantha"] <- "F"
wells$gender [wells$keychild == "debbie"] <- "F"
wells$gender [wells$keychild == "samantha"] <- "F"
wells$gender [wells$keychild == "sheila"] <- "F"
wells$gender [wells$keychild == "stella"] <- "F"
wells$gender [wells$keychild == "abigail"] <- "F"
wells$gender [wells$keychild == "geoffrey"] <- "M"
wells$gender [wells$keychild == "harriet"] <- "F" #assuming girl
wells$gender [wells$keychild == "laura"] <- "F"


#remove target child utts  aka 4,830 entries
#wells_input<- wells[!grepl("Target", wells$ROLE),] 
wells$speaker[wells$ROLE == "Mother"] <- "mother"
wells$speaker[grep("Sister|Brother|Sibling", wells$ROLE)]  <- "sibling"
wells$speaker[grep("Child|Playmate|child", wells$ROLE)]  <- "peer"
wells$speaker[grep("Adult|Uncle|Grandmother|Family_Friend|Visitor|Aunt|Father", wells$ROLE)]  <- "adult"
wells$speaker[grep("Target", wells$ROLE)] <- "Target_Child"


#name and save data
colnames(wells)<-c("NAME"   ,   "ROLE"   ,   "UTTERANCE", "COMMENT"  , "DIRECTED" , "empty"     ,    "empty2"     ,  "keychild" , "gender"   , "speaker")
write.table(wells, file=paste0("wells_input.txt"), row.names=F, col.names=T,  quote=F) 

#Sum the number of utterances per speaker category and keychild
aggregate(wells$UTTERANCE,by=list( wells$speaker, wells$keychild),length )->sum_wells
colnames(sum_wells) <- c("speaker", "keychild", "nb_utt")


try<- wells %>% group_by(keychild) %>% summarise(no_rows = length(keychild)) # 11866

#

``` 

```{r wells directedness, eval=TRUE, include=TRUE, message=FALSE}

#NOT WORKING FOR SOME REASON:
#read.table("wells_input.txt",header=F)->wells_input

#ADRESSEE ANNOTATIONS PART
wells_annotated_input<-subset(wells, !(wells$DIRECTED=="")) #select utterances annotated by Naomi Alex up to now , for now 3098 rows PLEASE UPDATE as we go !!

#Sum the number of utterances per speaker category and keychild
aggregate(wells_annotated_input$UTTERANCE,by=list( wells_annotated_input$speaker, wells_annotated_input$keychild),length )->sum_wells_annotated
colnames(sum_wells_annotated) <- c("speaker", "keychild", "nb_utt")


#Sum the number of utterances per speaker category and keychild and ADDRESSEE
aggregate(wells_annotated_input$UTTERANCE,by=list(wells_annotated_input$DIRECTED,  wells_annotated_input$speaker, wells_annotated_input$keychild),length )->sum_wells_addressee
colnames(sum_wells_addressee) <- c("addresse", "speaker", "keychild", "nb_utt")

# Utterances addressed to the target child  aka CDS
wells_child_directed<-subset(wells_annotated_input, (wells_annotated_input$DIRECTED=="CHI"))

aggregate(wells_child_directed$UTTERANCE,by=list(wells_child_directed$speaker, wells_child_directed$keychild),length )->sum_wells_CDS
colnames(sum_wells_CDS) <- c( "speaker", "keychild", "nb_utt")


# count different types of addressees 
wells_annotated_value<- wells_annotated_input %>% group_by(DIRECTED) %>% summarise(no_rows = length(DIRECTED))
#create a data.frame
wells_annotated_value<-as.data.frame(wells_annotated_value)
#Number of number  of utts that have annotated adressees
wells_total_annotated_input<-sum(wells_annotated_value$no_rows)  #2059
wells_annotated_value

# Utterances addressed to the target child  aka CDS
wells_child_directed<-subset(wells_annotated_input, (wells_annotated_input$DIRECTED=="CHI")) #wells annotated child-directed corpus
# n of child-directed utterances
length(wells_child_directed$UTTERANCE)/ length(wells_annotated_input$UTTERANCE)  * 100 #45.07042
#subset all utterances marked as CDS
wells_cd_directed_utts<- as.data.frame(wells_child_directed %>%select(UTTERANCE))
#export all CDS utterance into a text file
write.table(wells_cd_directed_utts, file=paste0( lang,"Wellschilddirected.txt"), row.names=F, col.names=T,  quote=F) 

# Utterances addressed to adults aka ADS

#for this it needed to know the corpus quite well... So I'm assuming that LOU - REB - RAC - CHR - 0 - NIC ARE NOT ADULTS right???
well_adult_directed<-subset(wells_annotated_input, !(wells_annotated_input$DIRECTED=="CHI" |wells_annotated_input$DIRECTED=="0" |wells_annotated_input$DIRECTED=="O" | wells_annotated_input$DIRECTED=="?" | wells_annotated_input$DIRECTED=="SELF"| wells_annotated_input$DIRECTED=="NIC"  | wells_annotated_input$DIRECTED=="TELEPHONE" | wells_annotated_input$DIRECTED=="MIX" | wells_annotated_input$DIRECTED=="LOU" | wells_annotated_input$DIRECTED=="REB" | wells_annotated_input$DIRECTED=="PET"| wells_annotated_input$DIRECTED=="RAC" | wells_annotated_input$DIRECTED=="CHR" | wells_annotated_input$DIRECTED=="NA"))
#subset all utterances marked as ADS
wells_ad_directed_utts<- as.data.frame(well_adult_directed %>%select(UTTERANCE))
#export all ADS utterance into a text file
write.table(wells_ad_directed_utts, file=paste0(lang, "Wellsadultdirected.txt"), row.names=F, col.names=T,  quote=F) 

 # n of adult directed utterances
length(wells_ad_directed_utts$UTTERANCE)/ length(wells_annotated_input$UTTERANCE) * 100 #22.38951 %

#NA annotations
#cs: whart about 0 ???
wells_annotated_na <- subset(wells_annotated_input,(wells_annotated_input$DIRECTED=="?"|wells_annotated_input$DIRECTED=="NA"|wells_annotated_input$DIRECTED==""|wells_annotated_input$DIRECTED==" "))
length(wells_annotated_na$UTTERANCE)/ length(wells_annotated_input$UTTERANCE) *100 # 5.68237 % 


```

```{r figure making, eval=TRUE, include=TRUE, message=FALSE}

#install libraries
library(ggplot2)
library(scales)
library(gridExtra)

#defining multiplot
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

#not normalized / all corpus
wells_full <- ggplot(sum_wells, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="dodge")
demuth_full <- ggplot(sum_demuth, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="dodge")

#not normalized / all corpus
wells_annot<- ggplot(sum_wells_annotated, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="dodge")
demuth_annot<- ggplot(sum_demuth_annotated, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="dodge")



wells_addresse<- ggplot(sum_wells_addressee, aes( y=nb_utt, x=keychild, fill=addresse))+
  geom_bar(stat="identity", position="dodge")
demuth_addresse<- ggplot(sum_demuth_addressee, aes( y=nb_utt, x=keychild, fill=addresse))+
  geom_bar(stat="identity", position="dodge")




wells_CDS<- ggplot(sum_wells_CDS, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="fill")
demuth_CDS<- ggplot(sum_demuth_CDS, aes( y=nb_utt, x=keychild, fill=speaker))+
  geom_bar(stat="identity", position="fill")


#panel
 multiplot (wells_full, demuth_full, cols=1)
 multiplot (wells_annot, demuth_annot, cols=1)
  
  
 multiplot (wells_CDS, demuth_CDS, cols=1) 
 
```
